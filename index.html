<!DOCTYPE html>
<html lang="ja">

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/style.css" media="screen">
  <link rel="stylesheet" href="css/print.css" media="print">
  <link rel="preconnect" href="https://fonts.googleapis.com"> 
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap" rel="stylesheet">
  
  <title>誕生日おめでとうマジック</title>

</head>
<body>


  <div id="input_form">
    <div class="form no_print">
      <form name="form" id="id_form" action="">
        名　前：
        <input name="textBoxName" id="id_textBoxName" type="text" size="25" value="るいちゃん" /><br>
        誕生日：
        <select name="selectMonth" id="id_selectMonth"></select> 月
        <select name="selectDay" id="id_selectDay"></select> 日<br>
        <div id="showMonthHoroscope">
          <input name="radioMonthHoroscope" id="radioMonth" type="radio" value="month" checked><label for="radioMonth">誕生月</label>
          <input name="radioMonthHoroscope" id="radioHoroscope" type="radio" value="horoscope"><label for="radioHoroscope">星座</label>
        </div>
        <div id="showStar">
          <label for="checkboxStar">流れ星：</label><input type="checkbox" name="checkboxStar" id="checkboxStar" checked>
        </div>
        <!--input type="button" value="生成" onclick="rearrangeCards();" /-->
        <input type="button" value="印刷" onclick="window.print();">
      </form>
    </div>
  </div>


  <div id="first_page">
      <p id="version" class="ver">ver. 20210705</p>
      <p id="memo" class="memo">1月1日</p>

      <div id="card-month">
      </div>

      <div id="card-horoscope">
      </div>

      <div id="card-day">
      </div>
      
      <img id="star2" class="star" src="img/star.svg">
      <img id="star4" class="star" src="img/star.svg">
      <img id="star6" class="star" src="img/star.svg">
      <img id="star8" class="star" src="img/star.svg">

      <img id="trim" src="img/trim200x280t5b12.svg">
      <img id="trim" src="img/dot180x257.svg">

  </div>

  <div id="second_page" class="print_pages">
    <div class="print_pages">
      <img id="cake" src="img/cake180x247t23b27.svg">
      <div id="birthdayname">るいちゃん</div>
      <div id="happybirthday">お誕生日おめでとう</div>
      <div id="birthdaymessage"></div>
    </div>
  </div>

  <div id="third_page">

    <div class="manual">
      <h2>『誕生日おめでとう！』</h2>

      <p>
        よく混ぜたカードを、誕生月（星座）が描かれているカードと描かれていないカードに分けて重ねます。
        次に誕生日が描かれているカードと描かれていないカードに分けて重ねます。
        カードを上から1枚ずつ並べて、表向きにすると「誕生日ケーキ」が現れます。
      </p>


      <h3>【演じ方 1】</h3>
      <p>
      「8枚のカードを裏を見ないで、よく混ぜます。」<br>
      「カードには1月（やぎ座）とか2月（みずがめ座）のように6つの月（星座）が描かれています。」<br>
      「その上下に日にちがランダムに描かれています。」<br>
      <br>
      「これからカードをふたつに分けて重ねるというのを、こんなふうにやってもらいます。」<br>
      「流れ星が描かれているカードをこちらに、描かれていないカードをこちらに置きます。」<br>
      「流れ星が描かれているカードの山を、描かれていないカードの上に重ねます。」<br>
      <br>
      「それでは同じように、上から1枚ずつ自分の誕生月（星座）が描かれたカードと、描かれていないカードとに分けてください。」<br>
      「誕生月（星座）が描かれたカードの山を、描かれていないカードの上に重ねてください。」<br>
      「今度は、誕生日が描かれたカードと、描かれていないカードとに分けてください。」<br>
      「誕生日が描かれたカードの山を、描かれていないカードの上に重ねてください。」<br>
      <br>
      「ではカードを上から1枚ずつ、左右交互に並べてください。」<br>
      □□<br>
      □□<br>
      □□<br>
      □□<br>
      「よく混ぜたカードを、自分の誕生月（星座）で分けて重ね、さらに誕生日で分けて重ねました。」<br>
      「それではカードを1枚ずつ裏返して見てください。」<br>
      </p>

      <h3>【演じ方 2】</h3>
      <p>
      8枚のカードを軽く混ぜます。<br>
      「カードには1月（やぎ座）とか2月（みずがめ座）のように6つの月（星座）が描かれています。」<br>
      「その上下に日にちがランダムに描かれています。」<br>
      カードの説明をしながら、ペンシルドット（流れ星）の描かれているカードと、描かれていないカードに分ます。<br>
      ペンシルドット（流れ星）の描かれていない4枚のカードを客に渡します。<br>
      「こちらのカードを裏を見ないで、よくまぜてください。」<br>
      残りのカード（ペンシルドット）は演者が混ぜます。<br>
      4枚のカードを返してもらい、その上に演者のカード（ペンシルドット）を重ねます。<br>
      <br>
      「これからカードをふたつに分けて重ねるというのを、こんなふうにやってもらいます。」<br>
      「自分の誕生月（星座）が描かれているカードをこちらに、描かれていないカードをこちらに置きます。」<br>
      「誕生月（星座）が描かれているカードの山を、描かれていないカードの上に重ねます。」<br>
      <br>
      「今度は、誕生日が描かれたカードと、描かれていないカードとに分けてください。」<br>
      「誕生日が描かれたカードの山を、描かれていないカードの上に重ねてください。」<br>
      <br>
      「ではカードを上から1枚ずつ、左右交互に並べてください。」<br>
      「よく混ぜたカードを、自分の誕生月で分けて重ね、さらに誕生日で分けて重ねました。」<br>
      「それではカードを1枚ずつ裏返して見てください。」<br>
      </p>

      <p>
      ※ 4枚のカードには、右下にペンシルドットが描かれています。<br>
      ※ カードを分けるところは、必ず上から1枚ずつ配りながら行います。<br>
      ※ ペンシルドット（流れ星）の描かれたカードを分けておき、演者がペンシルドット（流れ星）の描かれたカードを、客が描かれていないカードを混ぜることで、誕生月（星座）と誕生日だけの操作だけでも誕生日ケーキが現れるようになります。<br>
      ※ 中央のトリムマークに0.5mmずれた線を加えてあります。この線で切り抜くとペンシルドット（流れ星）の描かれていないカードがショートカードになり、上手くオーバーハンドシャッフルすることで、誕生月（星座）と誕生日だけの操作だけでも誕生日ケーキが現れるようになります。<br>
      ※ なんで？と聞かれたら、「変形2進降順基数ソートです」と答えています。ペンシルドット（流れ星）、誕生月（星座）、誕生日の「ある」「ない」の2通りで、それぞれで並べ変えているので、基数ソートと考えることができます。「ある」方を上に重ねているので降順となります。実際には、上から順番に配りながら分けているので、順序が入れ替わるため基数ソートとして成立していないのですが、変形と付けて誤魔化してみました。<br>
      </p>

      <p>
      原案：野呂茂樹 『先生はマジシャン 3』連合出版（2006）<br>
      構成：庄司タカヒト（きくえちゃんよくできました）
      </p>

      <p>
      2020年1月12日（日）に行われた碓氷貴光氏主催の交流会のために考えました。交流会の研究テーマは「記念日向けのトリック」ということだったので、オンデマンドで誕生日用パケットトリックが作成できると面白いのではと考えたオーダーメイドアニバーサリーマジックです。つまり、ホームページで誕生日を入力すると印刷用のPDFが生成され、印刷して切り抜けば世界でひとつだけのパケットができあがるというものです。
      </p>
      <p>
      交流会当日に試作したものは、誕生月ではなく星座を用いていました。デモ用の自分の誕生日のカードを作り終えた後に、どうせだったら碓氷氏の誕生日で作成しようと思い星座を調べたところ、誕生日が星座の境目に当たるようで、年によって星座が異なることが判明し、星座ではなく誕生月を使うことにしました。その後、解決策を思い付き星座でも生成できるようになりました。
      </p>

    </div>
  </div>

  <script type="text/javascript" language="javascript">
    function rearrangeCards() {
      var month = parseInt(document.forms.id_form.id_selectMonth.value);
      var day = parseInt(document.forms.id_form.id_selectDay.value);
      var birthdayname = document.forms.id_form.id_textBoxName.value;
      
      document.getElementById("birthdayname").innerHTML = birthdayname;
      document.getElementById("memo").innerHTML = month + '月' + day + '日';

      /* console.log(month, day, month % 2 * 2 + day % 2); */


      putMonth(month, day);
      
      /* console.log(getHoroscope(month, day)); */
      putHoroscope(month, day);

      arr = getRandomDayArray(day);
      putDay(arr);
    }

    const horoSvg = ['yagi.svg', 'mizugame.svg', 'uo.svg', 'ohitsuji.svg', 
                      'oushi.svg', 'futago.svg', 'kani.svg', 'shishi.svg', 
                      'otome.svg', 'tenbin.svg', 'sasori.svg', 'ite.svg'];
    
    const horoscopeName = ['山羊座', '水瓶座', '魚座', '牡羊座', '牡牛座', '双子座',
                            '蟹座', 'しし座', '乙女座', 'てんびん座', '蠍座', '射手座'];

    const selectMonth = document.getElementById('id_selectMonth');
    const selectDay = document.getElementById('id_selectDay');

    const checkboxStar = document.getElementById('checkboxStar');

    const radioMonth = document.getElementById('radioMonth');
    const radioHoroscope = document.getElementById('radioHoroscope');
    
    putHTML();

    function putHTML() {
      var card_day_arr = [];
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 6; i++) {
          var parentDiv = document.getElementById('card-month');
          var newElement = document.createElement('div');
          var newContent = document.createTextNode('13月');
          newElement.appendChild(newContent);
          newElement.setAttribute('id', 'card-month' + j + '-' + i);
          newElement.setAttribute('class', 'card-month');
 
          parentDiv.appendChild(newElement);
        }
      }
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 6; i++) {
          var parentDiv = document.getElementById('card-horoscope');
          var newElement = document.createElement('img');
          newElement.src = '';
          newElement.setAttribute('id', 'card-horoscope' + j + '-' + i);
          newElement.setAttribute('class', 'card-horoscope');
 
          parentDiv.appendChild(newElement);
        }
      }
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 2; i++) {
          var parentDiv = document.getElementById('card-day');
          var newElement = document.createElement('div');
          var newContent = document.createTextNode('1　2　3　4　10　11　12　13');
          newElement.appendChild(newContent);
          newElement.setAttribute('id', 'card-day' + j + '-' + i);
          newElement.setAttribute('class', 'card-day');
 
          parentDiv.appendChild(newElement);
        }
      }
    }

    function getRandom(without, min, max) {
      var random = Math.floor(Math.random() * (max + 1 - min)) + min;

      if (without < min || without > max) {
        return random;
      } else {
        while (random == without) {
          random = Math.floor(Math.random() * (max + 1 - min)) + min;
        }
      }

      console.log(random);
    }

    function getRandomDay(day, min, max) {
      var arr = Array(max - min + 1);
      for (let i = min; i <= max; i++) {
        arr[i - min] = i;
      }

      var b = arr.splice(day - min, 1);
      var a = arr.length;

      //シャッフルアルゴリズム
      while (a) {
        var j = Math.floor(Math.random() * a);
        var t = arr[--a];
        arr[a] = arr[j];
        arr[j] = t;
      }

      /* console.log(b); */
      /* console.log(arr); */
      return arr;
    }

    function getRandomDayArray(day) {
      var days = new Array(8);
      for (let i = 0; i < 8; i++) {
        var tmp = getRandomDay(day, 1, 31);
        days[i] = tmp.splice(0, 16);

        if (i < 4) {
          days[i][0] = day;
          days[i].sort(compareFunc);
        } else {
          days[i].sort(compareFunc);
        }
      }
      /* console.log(days); */

      return days;
    }

    function putDay(days) {
      var card_day_arr = [];
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 2; i++) {
          card_day_arr.push(document.getElementById("card-day" + j + "-" + i));
        }
      }
      /* console.log(card_day_arr); */

      for (let j = 0; j < 8; j++) {
        var daysStr1 = '';
        var daysStr2 = '';
        let numStr1 = 8;
        let numStr2 = 8;

        for (let i = 0; i < numStr1; i++) {
          daysStr1 += '<li>' + days[j][i] + '</li>';
        }
        for (let i = numStr1; i < numStr1 + numStr2; i++) {
          daysStr2 += '<li>' + days[j][i] + '</li>';
        }
        card_day_arr[j * 2 + 0].innerHTML = '<ul>' + daysStr1 + '</ul>';
        card_day_arr[j * 2 + 1].innerHTML = '<ul>' + daysStr2 + '</ul>';
      }
    }

    // dm. dm.
    // 100 101
    // 110 111
    // 000 001
    // 010 011

    // .md
    // 001
    // 101
    // 011
    // 111
    // 000
    // 100
    // 010
    // 110

    function compareFunc(a, b) {
      return a - b;
    }


    function putHoroscope(month, day) {
      let arr = getRandomHoroscopeArray(month, day);
      
      let cardHoroscopeArr = [];
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 6; i++) {
          cardHoroscopeArr.push(document.getElementById("card-horoscope" + j + "-" + i));
        }
      }
      /* console.log(cardHoroscopeArr); */

      for (let j = 0; j < 8; j++) {
        for (let i = 0; i < 6; i++) {
          cardHoroscopeArr[j * 6 + i].src = './img/' + horoSvg[arr[j][i] - 1];
        }
      }
    }

    function getRandomHoroscopeArray(month, day) {
      var arr = new Array(8);
      for (let j = 0; j < 8; j++) {
        arr[j] = [];
      }

      var horo = getHoroscope(month, day);
      /* console.log(horo); */
      var num = 8 * 6;
      var horo1 = 0;
      var horo2 = 0;

      /* for (let j = 0; j < 8; j++) {
        for (let i = 0; i < 6; i++) {
          arr[j][i] = (j % 2) + i * 2 + 1;
        }
      } */

      if (horo > 100) {
        horo1 = Math.floor(horo % 100);
        horo2 = Math.floor(horo / 100);
        /* console.log(horoscopeName[horo1 - 1], horoscopeName[horo2 - 1]); */
        arr[2][0] = horo1;
        arr[2][1] = horo2;
        arr[3][0] = horo1;
        arr[3][1] = horo2;
        arr[6][0] = horo1;
        arr[6][1] = horo2;
        arr[7][0] = horo1;
        arr[7][1] = horo2;
        num -= 8;
      } else {
        horo1 = horo;
        /* console.log(horoscopeName[horo1 - 1]); */
        arr[2][0] = horo1;
        arr[3][0] = horo1;
        arr[6][0] = horo1;
        arr[7][0] = horo1;
        num -= 4;
      }

      m = 1;
      for (let j = 0; j < 8; j++) {
        for (let i = arr[j].length; i < 6; i++) {
          while (m == horo1 || m == horo2) {
            m++;
            if (m > 12) m = 1;
          }
          arr[j][arr[j].length] = m;
          m++;
          if (m > 12) m = 1;
          num--;
        }
      }


      for (let m = 0; m < 200; m++) {
        var j = Math.floor(Math.random() * 8);
        var i = Math.floor(Math.random() * 6);
        while (arr[j][i] == horo1 || arr[j][i] == horo2) {
          j = Math.floor(Math.random() * 8);
          i = Math.floor(Math.random() * 6);
        }
        var l = Math.floor(Math.random() * 8);
        var k = Math.floor(Math.random() * 6);
        while (arr[l][k] == horo1 || arr[l][k] == horo2) {
          l = Math.floor(Math.random() * 8);
          k = Math.floor(Math.random() * 6);
        }
        if (arr[l].includes(arr[j][i]) || arr[j].includes(arr[l][k])) {
        } else {
          var t = arr[l][k];
          arr[l][k] = arr[j][i];
          arr[j][i] = t;
        }
      }


      for (let j = 0; j < 8; j++) {
        arr[j].sort(compareFunc);
      }
      /* console.log(arr); */

      return arr;
    }



    function getHoroscope(month, day) {
      month--; /* 0-11 */
      var flag_next = false;
      var border = [20, 19, 21, 20, 21, 22, 23, 23, 23, 24, 22, 22];
      var horo1 = month;
      var horo2 = 0;
      
      /* border day 17-23 */
      if (day >= 18 && day <= 24) {
        horo2 = (horo1 + 1) % 12;
        horo1++;
        horo2++;
        /* console.log(horoscopeName[horo1 - 1], horoscopeName[horo2 - 1]); */
      } else {
        if (day >= border[month]) {
          horo1 = (horo1 + 1) % 12;
        }
        horo1++;
        /* console.log(horoscopeName[horo1 - 1]); */
      }
      
      return horo1 + horo2 * 100;
    }

    function getHoroscopeOld(month, day) {
      var flag_next = false;
      var border = [20, 19, 21, 20, 21, 22, 23, 23, 23, 24, 22, 22];
      var index = month - 1;
      if (day >= border[index]) {
        index++;
        flag_next == true;
      }
      index %= 12;

      if (day >= 18 && day <= 24) {
        if (flag_next == true) {
          index += ((index + 1) % 12) * 100;
        } else {
          index += ((index + 11) % 12) * 100;
        }
      }
      /* border day 17-23 */

      return index;
    }

    function getRandomMonthArray(month) {
      /* 配列[8][6]のカードごとに偶数または奇数月を代入 */
      var arr = new Array(8);
      for (let j = 0; j < 8; j++) {
        arr[j] = new Array(6);
        for (let i = 0; i < 6; i++) {
          arr[j][i] = (j % 2) + i * 2 + 1;
        }
      }

      /* 200回入れ替える */
      for (let m = 0; m < 200; m++) {
        var i = Math.floor(Math.random() * 6);
        var j = Math.floor(Math.random() * 8);
        var k = Math.floor(Math.random() * 6);
        var l = Math.floor(Math.random() * 8);
        if (arr[l].includes(arr[j][i]) || arr[j].includes(arr[l][k])) {
        } else {
          var t = arr[l][k];
          arr[l][k] = arr[j][i];
          arr[j][i] = t;
        }
      }

      for (let j = 0; j < 8; j++) {
        arr[j].sort(compareFunc);
      }

      var tmp = new Array(8);
      var t = 0;
      var f = 0;
      for (let j = 0; j < 8; j++) {
        if (arr[j].includes(month)) {
          tmp[t + 2 + (t > 1) * 2] = arr[j];
          t++;
        } else {
          tmp[f + 0 + (f > 1) * 2] = arr[j];
          f++;
        } 
      }
      
      /* console.log(tmp); */
      return tmp;
    }

    function putMonth(month, day) {
      let arr = getRandomMonthArray(month);
      
      var cardMonthArr = [];
      for (let j = 1; j <= 8; j++) {
        for (let i = 1; i <= 6; i++) {
          cardMonthArr.push(document.getElementById("card-month" + j + "-" + i));
        }
      }
      /* console.log(cardMonthArr); */

      for (let j = 0; j < 8; j++) {
        for (let i = 0; i < 6; i++) {
          cardMonthArr[j * 6 + i].innerText = arr[j][i] + '月';
        }
      }
    }

    function setSelectMonth() {
      // 月を生成(12)
      for (let i = 1; i <= 12; i++) {
        let op = document.createElement('option');
        op.value = i;
        op.text = i;
        selectMonth.appendChild(op);
      }
    }

    function setSelectDay() {
      let children = selectDay.children
      while (children.length) {
        children[0].remove()
      }
      if (selectMonth.value !== '') {
        /* console.log(selectMonth.value); */
        const last_day = new Date(2020, selectMonth.value, 0).getDate();

        for (let i = 1; i <= last_day; i++) {
          let option = document.createElement('option');
          option.value = i;
          option.text = i;
          selectDay.appendChild(option);
        }
      }
    }

    function setVersion() {
      var modified = new Date(document.lastModified);
      var year  = modified.getFullYear();
      var month = ('0' + (modified.getMonth() + 1)).slice(-2);
      var date  = ('0' + modified.getDate()).slice(-2);

      document.getElementById("version").innerHTML = 'ver. ' + year + month + date;
    }

    function showStar() {
      var star = document.getElementsByClassName('star');
      if (checkboxStar.checked) {
        for (var i = 0; i < star.length; i++) {
            star[i].style.display = "block";
        }
      } else {
        for (var i = 0; i < star.length; i++) {
          star[i].style.display = "none";
        }
      }
    }

    function showHoro() {
      var horo = document.getElementsByClassName('card-horoscope');
      var month = document.getElementsByClassName('card-month');
      if (radioHoroscope.checked) {
        for (var i = 0; i < horo.length; i++) {
            horo[i].style.display = "block";
        }
        for (var i = 0; i < month.length; i++) {
            month[i].style.display = "none";
        }
      } else {
        for (var i = 0; i < horo.length; i++) {
          horo[i].style.display = "none";
        }
        for (var i = 0; i < month.length; i++) {
            month[i].style.display = "block";
        }
      }
    }

    window.onload = function() {
      setVersion();
      setSelectMonth();
      setSelectDay();
      showHoro();

      rearrangeCards();
      selectMonth.addEventListener('change', setSelectDay, false);
      selectMonth.addEventListener('change', rearrangeCards, false);
      selectDay.addEventListener('change', rearrangeCards, false);
      checkboxStar.addEventListener('change', showStar, false);
      radioMonth.addEventListener('change', showHoro, false);
      radioHoroscope.addEventListener('change', showHoro, false);
      document.forms.id_form.id_textBoxName.addEventListener('change', rearrangeCards, false);
    };

  </script>

  </body>
</html>
